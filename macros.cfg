[gcode_macro PRIME_NOZZLE]
gcode:
    SAVE_GCODE_STATE NAME=PRIME_NOZZLE_STATE
    M117 Priming
    G90                 ; Absolute coordinates.
    M83                 ; Relative extruder mode.
    G92 E0
    ; Move to start of line.
    G1 Z10 F900
    G1 Y3 X3 F9000
    G1 Z0.2 F900
    ; Print the line.
    G91                ; Relative coordinates.
    G1 X100 E25 F1000  ; Extrude filament 25mm (how much it retracted in PRINT_END).
    G1 Y-2 F1000
    G1 X-60 E9 F1000    ; Print second part of the line.
    G1 E-0.5 F1000      ; Retract to avoid stringing.
    G1 X0.5 E-0.5 F1000    ; Wipe back to break string.
    G1 X-5.5 E0 F1000   ; Wipe forward to break string.
    RESTORE_GCODE_STATE NAME=PRIME_NOZZLE_STATE


[gcode_macro START_PRINT]
gcode:
      #Get Printer built volume dimensions
      {% set X_MAX = printer.toolhead.axis_maximum.x|default(245)|float %}
      {% set Y_MAX = printer.toolhead.axis_maximum.y|default(245)|float %}
      {% set Z_MAX = printer.toolhead.axis_maximum.z|default(250)|float %}

      #Get Bed and Extruder temperature from Slicer GCode
      {% set BED_TEMP = params.BED_TEMP|default(100)|float %}
      {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(255)|float %}
      #Preheat nozzle and bed
      M104 S{EXTRUDER_TEMP - 60} T0
      M140 S{BED_TEMP}
      M106 S255

      #Heat soak
      #G4 P1800000  ##30 min
      #G4 p900000  ##15 min
      #G4 p600000  ##10 min

      # Use absolute coordinates
      G90

      #Home
      G28

      #Move up to clean bed
      G1 Y{Y_MAX - 20} Z{Z_MAX/4.0} F6000

      #Heat nozzle and bed
      M190 S{BED_TEMP}
      Z_TILT_ADJUST
      BED_MESH_CALIBRATE
      M109 S{EXTRUDER_TEMP} T0

      PRIME_NOZZLE
      # Prime line
      #PRIME_LINE

[gcode_macro END_PRINT]
gcode:
      #Get Printer built volume dimensions
        {% set X_MAX = printer.toolhead.axis_maximum.x|default(245)|float %}
        {% set Y_MAX = printer.toolhead.axis_maximum.y|default(245)|float %}
        {% set Z_MAX = printer.toolhead.axis_maximum.z|default(255)|float %}

      #Fix-up extruder
      G91                                            
      G1 E-2 F2700                                    
      G1 E-1.5 Z0.2 F2400                        
      G1 X5 Y5 F6000                               
      G1 Z10                                     
      G90                                        

      #Present print
      #G1 Z{printer.toolhead.position.z + 25} F600
      G1 X{122} Y{Y_MAX - 20} Z{245} F6000
      M106 S0                                      
      M104 S0                                       
      M140 S0                                 

        #Disable Steppers
        M84 X Y E